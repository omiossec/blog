<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Running Linux on Hyper-V - Olivier Miossec</title><meta name="robots" content="index, follow"><meta name="generator" content="Publii Open-Source CMS for Static Site"><link rel="canonical" href="https://omiossec.github.io/blog/running-linux-on-hyper-v.html"><link rel="amphtml" href="https://omiossec.github.io/blog/amp/running-linux-on-hyper-v.html"><link type="application/atom+xml" rel="alternate" href="https://omiossec.github.io/blog/feed.xml"><meta property="og:title" content="Running Linux on Hyper-V"><meta property="og:site_name" content="My blog - Olivier Miossec"><meta property="og:description" content="With Windows 2008, running Linux as guest OS on hyper-v was sometime difficult. If you wanted to install old version of Ubuntu or a Network Virtual Appliance like pfsense you had to use Emulated device and/or to manually load hyper-v driver. Performance was sometime poor."><link rel="stylesheet" href="https://omiossec.github.io/blog/assets/css/style.css?v=9fd6fcc5df15fe452276772c686a3300"><script type="application/ld+json">{"@context":"http://schema.org","@type":"Article","mainEntityOfPage":{"@type":"WebPage","@id":"https://omiossec.github.io/blog/running-linux-on-hyper-v.html"},"headline":"Running Linux on Hyper-V","datePublished":"2018-03-10T22:07","dateModified":"2018-03-10T22:07","description":"With Windows 2008, running Linux as guest OS on hyper-v was sometime difficult. If you wanted to install old version of Ubuntu or a Network Virtual Appliance like pfsense you had to use Emulated device and/or to manually load hyper-v driver. Performance was sometime poor.","author":{"@type":"Person","name":"Olivier Miossec"},"publisher":{"@type":"Organization","name":"Olivier Miossec"}}</script><script async src="https://omiossec.github.io/blog/assets/js/lazysizes.min.js?v=739e7d27e1cbc58b1b2e6882674b8867"></script></head><body><div class="container"><nav class="menu"><ul class="navbar__menu"></ul><button class="menu__close js-menu__close">Close</button></nav><div class="content js-content"><header><div class="top"><a class="logo" href="https://omiossec.github.io/blog">Olivier Miossec</a></div><div class="top top--right is-sticky"></div></header><main class="main"><article class="post"><div class="main__left"><header><h1>Running Linux on Hyper-V</h1><p><time datetime="2018-03-10T22:07">10 Mar 2018 </time>by <a href="https://omiossec.github.io/blog/authors/olivier-miossec/" rel="author" title="Olivier Miossec">Olivier Miossec</a></p></header></div><div class="main__right"><div class="post__entry"><p>With Windows 2008, running Linux as guest OS on hyper-v was sometime difficult. If you wanted to install old version of Ubuntu or a Network Virtual Appliance like pfsense you had to use Emulated device and/or to manually load hyper-v driver. Performance was sometime poor.</p><p>It’s now part of History. In July 2009, Microsoft released Hyper-v drivers for Linux under GPLv2 license. There was 7 drivers vmbus, storvsc, blkvsc, netvsc,utils and timesource in Hyper-v 2008 R2, much more in Windows 2012 R2 and Windows 2016. Modern Linux version can now run in the same way as Windows Guest and offer performance near bare metal version.</p><p>Now most feature available in windows 2012 R2 as guest are available in the latest version of major linux distribution and some of FreeBds/Linux based network virtual appliance.</p><p>Secure boot, the anti-rootkit in generation 2 VM, work with Ubuntu 16 on Windows 2016 (you have to choose “MicrosoftUEFICertificateAuthority” as secure boot template).</p><p>Here the functions available in Linux and FreeBsd: <a href="https://technet.microsoft.com/fr-fr/library/dn531031.aspx">https://technet.microsoft.com/fr-fr/library/dn531031.aspx</a></p><p>You can find more information about feature and Ubuntu: <a href="https://technet.microsoft.com/fr-fr/library/dn531029.aspx">https://technet.microsoft.com/fr-fr/library/dn531029.aspx</a></p><p>Installing modern Linux OS on Hyper-V 2012 R2/2016 is as simple as installing Windows Server OS.</p><p><strong>But there are some best practices to follows.</strong></p><p>When using dynamic disk with windows, you may need to create the VHDX file in Powershell. You can use a 1 MB block size for the VHDX file (not the logical or physical sector size).</p><pre>PS&gt; New-VHD –Path x:\localion\VMLinux.vhdx –SizeBytes 80GB –Dynamic –BlockSizeBytes 1MB
</pre><p>Doing so will prevent the growing of the VHDX file because of the free space used in some Linux Filesystem. Inside a VM you should always use ext4 You should also change de way how Linux schedule I/O to first in first out to pass the schedule choice to the hypervisor.</p><pre>$sudo nano /etc/default/grub
/// 

Change the line 
</pre><p>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash"</p><pre>to 

</pre><pre>GRUB_CMDLINE_LINUX_DEFAULT="quiet splash elevator=noop"
</pre><pre>Than 

 
</pre><p>$sudo update-grub</p><pre>And restart 

You will need to modify the GRUB menu too if the VM has more 8 vcpu or more or more than 30 GB


&gt; 
</pre><blockquote><p>$sudo nano /etc/default/grub GRUB_CMDLINE_LINUX_DEFAULT="quiet splash elevator=noop numa=off" /// Than /// $sudo update-grub ///</p></blockquote><p>Also if you find that the resolution in the vconnect is too small for your need you can add this to the GRUB video=hyperv_fb:XXXxXXX</p><p>Don’t forget to update the GRUB and restart the server<br><br></p><p>If you had Linux VM into a hyper-v Cluster, you may need to use static MAC address. During fail over the new mac address can trigger network restart on the guest.</p><p>If you use Ubuntu LTS 14.04, 16.04 or 12.04 you can in update the kernel with the latest Hardware Enablement.</p><blockquote><p>16.04 $sudo apt-get update $sudo apt-get install --install-recommends linux-virtual-lts-xenial</p></blockquote><blockquote><p>14.04 $sudo apt-get update $sudo apt-get install --install-recommends linux-virtual-lts-wily</p></blockquote><blockquote><p>12.04 $sudo apt-get update $sudo apt-get install --install-recommends linux-generic-lts-trusty</p></blockquote><p>Then you need to add hyper-v daemons</p><blockquote><p>16.04 $sudo apt-get install --install-recommends linux-tools-virtual-lts-xenial linux-cloud-tools-virtual-lts-xenial</p><p>14.04 $sudo apt-get install --install-recommends hv-kvp-daemon-init linux-tools-virtual-lts-wily linux-cloud-tools-virtual-lts-wily</p><p>12.04 $sudo apt-get install --install-recommends hv-kvp-daemon-init linux-tools-lts-trusty linux-cloud-tools-generic-lts-trusty</p></blockquote><p>Rarely kernel update can do more arms than good. Last year in September, the Kernel 3.16.0.48 triggered network and I/O problems.</p><blockquote><p>hv_netvsc vmbus_0_12 eth0: unable to send receive completion pkt (tid XXXX)...retrying 4</p></blockquote><p><a href="https://bugs.launchpad.net/ubuntu/+source/linux-lts-utopic/+bug/1491957">https://bugs.launchpad.net/ubuntu/+source/linux-lts-utopic/+bug/1491957</a></p><p><strong>Automation</strong> There are no sysprep equivalent in the linux world, so how it’s possible to spawn a VM without installing it from the DVDRom. There is a solution, most Linux distribution provides cloud image, OS image optimized for cloud hosting.</p><p>from Ubuntu <a href="http://cloud-images.ubuntu.com/xenial/">http://cloud-images.ubuntu.com/xenial/</a></p><p>It’s possible to use this version with Hyper-V. Then you have cloud-init, a tool used in Open-Stack to enable cloud automation. In Hyper-v we can’t not use cloudinit as it’s used in Open-Stack. We need to relay on CDRom to enter information.</p><p>You can check this sample on GitHub</p><p><a href="https://github.com/Microsoft/Virtualization-Documentation/blob/master/hyperv-samples/benarm-powershell/Ubuntu-VM-Build/BaseUbuntuBuild.ps1">https://github.com/Microsoft/Virtualization-Documentation/blob/master/hyperv-samples/benarm-powershell/Ubuntu-VM-Build/BaseUbuntuBuild.ps1</a></p><p>You just need to remember that the user in: password: $($GuestAdminPassword) is Ubuntu</p><p>You can setup the IP address for the server</p><blockquote><p>instance-id: iid-abcdefg network-interfaces: | auto lo iface lo inet loopback</p><p>iface eth0 inet static address 192.168.10.10 network 192.168.10.0 netmask 255.255.255.0 broadcast 192.168.10.255 gateway 192.168.1O.1 hostname: MyServer</p></blockquote><aside class="post__share"><a href="https://twitter.com/share?url=https%3A%2F%2Fomiossec.github.io%2Fblog%2Frunning-linux-on-hyper-v.html&amp;via=omiossec_med&amp;text=Running%20Linux%20on%20Hyper-V" class="js-share twitter" title="Share with Twitter" rel="nofollow"><svg class="icon"><use xlink:href="https://omiossec.github.io/blog/assets/svg/svg-map.svg#twitter"/></svg> </a><a href="https://pinterest.com/pin/create/button/?url=https%3A%2F%2Fomiossec.github.io%2Fblog%2Frunning-linux-on-hyper-v.html&amp;media=undefined
                                    &amp;description=Running%20Linux%20on%20Hyper-V" class="js-share pinterest" title="Share with Pinterest" rel="nofollow"><svg class="icon"><use xlink:href="https://omiossec.github.io/blog/assets/svg/svg-map.svg#pinterest"/></svg> </a><a href="http://www.linkedin.com/shareArticle?url=https%3A%2F%2Fomiossec.github.io%2Fblog%2Frunning-linux-on-hyper-v.html&amp;title=Running%20Linux%20on%20Hyper-V" class="js-share linkedin" title="Share with LinkedIn" rel="nofollow"><svg class="icon"><use xlink:href="https://omiossec.github.io/blog/assets/svg/svg-map.svg#linkedin"/></svg></a></aside><footer><div class="post__bio"><img src="file:///C:/Users/olivi/Documents/Publii/sites/olivier-miossec/input/media/website/28a5a80f-9e64-4476-b92d-025cc77e54cf.jpg" alt="Olivier Miossec"><h3><a href="https://omiossec.github.io/blog/authors/olivier-miossec/" title="Olivier Miossec">Olivier Miossec</a></h3><p>IT Pro in Paris https://www.linkedin.com/in/omiossec/</p></div></footer></div></div></article></main><footer class="footer"><div class="footer__copyright">Powered by Publii</div></footer></div></div><div class="cookie-bar js-cookie-bar"><p>We use cookies to ensure that we give you the best experience on our website. If you continue, we will assume that you agree to our <a href="#">cookie policy.</a> <button class="cookie-bar__close">Close</button></p></div><script>var loadCSSFiles = function() {
        		var links = ['https://fonts.googleapis.com/css?family=Roboto:400,500'],
        			headElement = document.getElementsByTagName('head')[0],
        			linkElement, i;
        		for (i = 0; i < links.length; i++) {
        			linkElement = document.createElement('link');
        			linkElement.rel = 'stylesheet';
        			linkElement.href = links[i];
        			headElement.appendChild(linkElement);
        		}
        	};
        	var raf = requestAnimationFrame || mozRequestAnimationFrame || webkitRequestAnimationFrame || msRequestAnimationFrame;
        	if (raf) {
        		raf(loadCSSFiles);
        	} else {
        		window.addEventListener('load', loadCSSFiles);
        	}</script><script defer="defer" src="https://code.jquery.com/jquery-3.2.1.slim.min.js" integrity="sha256-k2WSCIexGzOj3Euiig+TlR8gA0EmPjuc79OEeY5L45g=" crossorigin="anonymous"></script><script defer="defer" src="https://omiossec.github.io/blog/assets/js/scripts.min.js?v=26d3bc49d3a07b5c3737fd74ea1ba4d4"></script></body></html>